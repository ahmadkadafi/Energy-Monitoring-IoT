<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Energy Monitoring Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

</head>

<body>

<!-- SIDEBAR -->
{% include "layout/sidebar.html" %}

<div class="content">

    <!-- HEADER -->
    <div class="mb-4">
        <h3 class="mb-0">Energy Monitoring Dashboard</h3>
        <small class="text-muted">
            Device: <b>{{ device }}</b> |
            Now: <span id="nowTime">--</span> |
            Last Update: <span id="lastUpdate">--</span>
        </small>
    </div>

    <!-- CURRENT VALUES -->
    <div class="row g-3 mb-4 text-center h5" id="latestRow"></div>

    <!-- CHARTS -->
    <div class="row g-4">
        <div class="col-md-6"><div class="card p-3"><h5>Voltage (V)</h5><canvas id="chartVoltage"></canvas></div></div>
        <div class="col-md-6"><div class="card p-3"><h5>Current (A)</h5><canvas id="chartCurrent"></canvas></div></div>
        <div class="col-md-6"><div class="card p-3"><h5>Power (W)</h5><canvas id="chartPower"></canvas></div></div>
        <div class="col-md-6"><div class="card p-3"><h5>Energy (kWh)</h5><canvas id="chartEnergy"></canvas></div></div>
        <div class="col-md-6"><div class="card p-3"><h5>Frequency (Hz)</h5><canvas id="chartFrequency"></canvas></div></div>
        <div class="col-md-6"><div class="card p-3"><h5>Power Factor</h5><canvas id="chartPF"></canvas></div></div>
    </div>

</div>

<!-- FOOTER -->
{% include "layout/footer.html" %}

<script>
// ================= AUTO REFRESH =================
setInterval(() => {
    location.reload();
}, 120000);

// ================= TIME =================
function updateNowTime() {
    document.getElementById("nowTime").innerText = new Date().toLocaleString();
}
setInterval(updateNowTime, 1000);
updateNowTime();

// ================= LATEST DATA =================
fetch("/api/latest/{{ device }}")
.then(res => res.json())
.then(d => {
    document.getElementById("lastUpdate").innerText = d.updated_at;
    document.getElementById("latestRow").innerHTML = `
    ${metricCard("bolt","primary",d.voltage,"V","Voltage")}
    ${metricCard("wave-square","success",d.current,"A","Current")}
    ${metricCard("plug","danger",d.power,"W","Power")}
    ${metricCard("battery-full","warning",d.energy,"kWh","Energy")}
    ${metricCard("sync","info",d.frequency,"Hz","Frequency")}
    ${metricCard("percent","secondary",d.pf,"","PF")}
    `;
});

function metricCard(icon,color,value,unit,label){
    return `
    <div class="col-md-2">
        <div class="card p-3">
            <div class="metric-icon text-${color}">
                <i class="fas fa-${icon}"></i>
            </div>
            <div class="metric">${value} ${unit}</div>
            <div class="metric-label">${label}</div>
        </div>
    </div>`;
}

// ================= CHARTS =================
fetch("/api/chart/{{ device }}")
.then(res => res.json())
.then(d => {

function makeChart(id, data) {
    new Chart(document.getElementById(id), {
        type: "line",
        data: {
            labels: d.time,
            datasets: [{
                data: data,
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0
            }]
        },
        options: {
            plugins:{ legend:{ display:false }},
            scales:{ x:{ ticks:{ maxTicksLimit:6 }}}
        }
    });
}

makeChart("chartVoltage", d.voltage);
makeChart("chartCurrent", d.current);
makeChart("chartPower", d.power);
makeChart("chartEnergy", d.energy);
makeChart("chartFrequency", d.frequency);
makeChart("chartPF", d.pf);

});
</script>

</body>
</html>
