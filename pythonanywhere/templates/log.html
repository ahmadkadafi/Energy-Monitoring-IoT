<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Energy Log Data</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

</head>
<body>

{% include "layout/sidebar.html" %}

<div class="content">

    <h3 class="page-title mb-2">
        <i class="fas fa-database me-2"></i>Energy Log Data
    </h3>
    <p class="page-subtitle mb-3">
        Data perekaman sensor energi (urut waktu terbaru)
    </p>

    <!-- ================= FILTER & EXPORT ================= -->
    <div class="card p-3 mb-3">
        <div class="row g-2 align-items-end">

            <div class="col-md-3">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" id="fromDate">
            </div>

            <div class="col-md-3">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" id="toDate">
            </div>

            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyFilter()">
                    <i class="fas fa-filter me-1"></i>Filter
                </button>
            </div>

            <div class="col-md-2">
                <button class="btn btn-secondary w-100" onclick="resetFilter()">
                    <i class="fas fa-rotate-left me-1"></i>Reset
                </button>
            </div>

            <div class="col-md-2 text-end">
                <div class="btn-group">
                    <button class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-file-export me-1"></i>Export
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="#" onclick="exportCSV()">
                                <i class="fas fa-file-csv me-2"></i>CSV
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="exportExcel()">
                                <i class="fas fa-file-excel me-2"></i>Excel
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <!-- ================= TABLE ================= -->
    <div class="card p-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="logTable">
                <thead class="table-dark">
                    <tr>
                        <th>No</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Voltage (V)</th>
                        <th>Current (A)</th>
                        <th>Power (W)</th>
                        <th>Energy (kWh)</th>
                        <th>Frequency (Hz)</th>
                        <th>PF</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- PAGINATION -->
        <nav>
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
    </div>

</div>

{% include "layout/footer.html" %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const pageSize = 15;
let currentPage = 1;
let data = [];
let filteredData = [];

/* ================= FETCH DATA ================= */
fetch("/api/log/{{ device }}")
.then(res => res.json())
.then(res => {
    data = res;
    filteredData = [...data];
    renderTable();
    renderPagination();
});

/* ================= RENDER TABLE ================= */
function renderTable() {
    const tbody = document.querySelector("#logTable tbody");
    tbody.innerHTML = "";

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = filteredData.slice(start, end);

    pageData.forEach(row => {
        tbody.innerHTML += `
            <tr>
                <td>${row.no}</td>
                <td>${row.date}</td>
                <td>${row.time}</td>
                <td>${row.voltage}</td>
                <td>${row.current}</td>
                <td>${row.power}</td>
                <td>${row.energy}</td>
                <td>${row.frequency}</td>
                <td>${row.pf}</td>
            </tr>
        `;
    });
}

/* ================= PAGINATION ================= */
function renderPagination() {
    const totalPages = Math.ceil(filteredData.length / pageSize);
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    const maxVisible = 5; // jumlah nomor halaman yang ditampilkan
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = startPage + maxVisible - 1;

    if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    /* PREVIOUS */
    pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goPage(${currentPage - 1})">
                &laquo; Prev
            </a>
        </li>
    `;

    /* PAGE NUMBERS */
    for (let i = startPage; i <= endPage; i++) {
        pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="goPage(${i})">${i}</a>
            </li>
        `;
    }

    /* NEXT */
    pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goPage(${currentPage + 1})">
                Next &raquo;
            </a>
        </li>
    `;
}

function goPage(page) {
    currentPage = page;
    renderTable();
    renderPagination();
}

/* ================= FILTER ================= */
function applyFilter() {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;

    filteredData = data.filter(row => {
        if (!from && !to) return true;
        if (from && row.date < from) return false;
        if (to && row.date > to) return false;
        return true;
    });

    currentPage = 1;
    renderTable();
    renderPagination();
}

function resetFilter() {
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    filteredData = [...data];
    currentPage = 1;
    renderTable();
    renderPagination();
}

/* ================= EXPORT ================= */
function exportCSV() {
    if (!filteredData.length) {
        alert("Data kosong!");
        return;
    }

    let csv = [];

    // HEADER
    const headers = [
        "No","Date","Time","Voltage (V)","Current (A)",
        "Power (W)","Energy (kWh)","Frequency (Hz)","PF"
    ];
    csv.push(headers.join(","));

    // DATA
    filteredData.forEach(row => {
        csv.push([
            row.no,
            row.date,
            row.time,
            row.voltage,
            row.current,
            row.power,
            row.energy,
            row.frequency,
            row.pf
        ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(","));
    });

    const csvContent = "\uFEFF" + csv.join("\n");
    downloadFile(csvContent, "energy_log.csv", "text/csv;charset=utf-8;");
}

function exportExcel() {
    if (!filteredData.length) {
        alert("Data kosong!");
        return;
    }

    let html = `
    <html>
    <head>
        <meta charset="UTF-8">
        <style>
            table { border-collapse: collapse; }
            th, td { border:1px solid #000; padding:5px; }
        </style>
    </head>
    <body>
    <table>
        <thead>
            <tr>
                <th>No</th>
                <th>Date</th>
                <th>Time</th>
                <th>Voltage (V)</th>
                <th>Current (A)</th>
                <th>Power (W)</th>
                <th>Energy (kWh)</th>
                <th>Frequency (Hz)</th>
                <th>PF</th>
            </tr>
        </thead>
        <tbody>
    `;

    filteredData.forEach(row => {
        html += `
        <tr>
            <td>${row.no}</td>
            <td>${row.date}</td>
            <td>${row.time}</td>
            <td>${row.voltage}</td>
            <td>${row.current}</td>
            <td>${row.power}</td>
            <td>${row.energy}</td>
            <td>${row.frequency}</td>
            <td>${row.pf}</td>
        </tr>
        `;
    });

    html += `
        </tbody>
    </table>
    </body>
    </html>
    `;

    downloadFile(html, "energy_log.xls", "application/vnd.ms-excel");
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}
</script>

</body>
</html>
